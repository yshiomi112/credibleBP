{% extends "global/Page.html" %}
{% block title %}ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ—ãƒ©ãƒ³ã®ä¿®æ­£ï¼ˆ{{ round_label }}ï¼‰{% endblock %}
{% block content %}

<!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€ â¶  ã‚¹ã‚¿ã‚¤ãƒ« â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<style>
.slider-container{display:flex;justify-content:space-between;gap:40px;margin-bottom:30px;}
.slider-box{flex:1;position:relative;}
/* ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼æœ¬ä½“ */
.color-slider{
  -webkit-appearance:none;width:100%;height:20px;border-radius:10px;
  background:#ddd;outline:none;margin-top:10px;
}
.color-slider::-webkit-slider-thumb{
  -webkit-appearance:none;appearance:none;width:36px;height:36px;border-radius:50%;
  background:white;border:2px solid gray;cursor:pointer;margin-top:-8px;
}
/* thumb ç„¡ã—ã®è¡¨ç¤ºå°‚ç”¨ãƒãƒ¼ */
.no-thumb::-webkit-slider-thumb{display:none;}
.no-thumb{pointer-events:none;}

/* â–²ãƒãƒ¼ã‚«ãƒ¼ */
.marker{
  position:absolute;top:27px;
  width:0;height:0;
  border-left:7px solid transparent;
  border-right:7px solid transparent;
  border-top:10px solid black;
  pointer-events:none;opacity:.7;
}

.prob-value{display:inline-block;padding:4px 8px;font-size:1.5em;font-weight:bold;
            border:2px solid #ccc;border-radius:6px;margin:0 4px;}
.message-line{margin-bottom:10px;line-height:1.8;}

/* ã‚¿ã‚¤ãƒãƒ¼è¡¨ç¤º */
#countdown-timer-box {
  background-color: #fff4cc;
  border-radius: 10px;
  padding: 12px 20px;
  font-size: 1.2em;
  font-weight: bold;
  color: #444;
  text-align: center;
  margin: 20px 0;
}
#timeout-warning {
  display: none;
  background: #ffe0e0;       /* â† ç¾åœ¨ã®èµ¤ã£ã½ã„èƒŒæ™¯è‰²ã‚’ç¶­æŒ */
  border-radius: 10px;       /* â† ä¸¸è§’ã‚’è¿½åŠ  */
  padding: 10px 20px;
  margin: 20px 0;
  font-weight: bold;
  text-align: center;
  color: #800000;            /* ä»»æ„ï¼šã‚„ã‚„æ¿ƒã„èµ¤å­—ã«ã—ã¦å¼·èª¿ */
}

.box-wrapper {
  background-color: #fdfdfd;
  border: 1px solid #888;
  border-radius: 12px;
  padding: 20px;
  margin: 20px 0;
}
.box-heading {
  font-size: 1.2em;
  font-weight: bold;
  margin-bottom: 12px;
}
.box-wrapper.light {
  border-color: #ddd;  /* â† éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªæ ã¯è–„ã„ã‚°ãƒ¬ãƒ¼ã« */
}
.marker-inline{
  display:inline-block;          /* ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã§é…ç½®            */
  width:0; height:0;             /* ä¸‰è§’å½¢ã‚’ä½œã‚‹ã¨ãã¯ 0Ã—0  */
  border-left:7px solid transparent;
  border-right:7px solid transparent;
  border-top:10px solid black;   /* .marker ã¨åŒã˜å‘ãï¼ˆâ–¼ï¼‰ */
  opacity:.7;                    /* åŒã˜åŠé€æ˜æ„Ÿ                */
  vertical-align:middle;         /* æ–‡å­—ã¨ã®é«˜ã•ã‚’ãã‚ãˆã‚‹      */
  margin:0 2px;                  /* ã€Œã€ã‹ã‚‰å°‘ã—ä½™ç™½             */
}

</style>

<!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€ â·  æœ¬æ–‡ â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->

{# --- è¿½åŠ ï¼å¤‰æ›´ --- #}
{% if player.round_number not in [1, 2] %}
<div id="countdown-timer-box">
  âŒ›ï¸ ã“ã®ãƒšãƒ¼ã‚¸ã§ã®æ®‹ã‚Šæ™‚é–“ <strong id="time-left">1:00</strong>
</div>

<div id="timeout-warning">
  â° æ™‚é–“ãŒçµŒéã—ã¾ã—ãŸã€‚ãªã‚‹ã¹ãæ—©ãé¸æŠã—ã¦ãã ã•ã„ã€‚
</div>
{% endif %}

<p>ä¸‹ã®æ å†…ã®ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚’æ“ä½œã™ã‚‹ã“ã¨ã§ã€å‰ã®ãƒšãƒ¼ã‚¸ã§ã‚ãªãŸãŒå…¬é–‹ã—ãŸã€Œãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ—ãƒ©ãƒ³ã€ã‚’ä¸€éƒ¨ä¿®æ­£ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚<p>
<p>ãŸã ã—ã€ä¿®æ­£ã®éš›ã«ã¯ã‚ãªãŸãŒå…¬é–‹ã—ãŸã€Œå…¨ä½“ã§ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ç¢ºç‡ã€ã‚’å¤‰æ›´ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚<p>
<p>ãã®ãŸã‚ä¸€æ–¹ã®ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚’å‹•ã‹ã™ã¨ã€ä»–æ–¹ã®ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã¯ã€Œå…¨ä½“ã§ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ç¢ºç‡ã€ãŒå¤‰ã‚ã‚‰ãªã„ã‚ˆã†ã«è‡ªå‹•çš„ã«èª¿æ•´ã•ã‚Œã¾ã™ã€‚<p>
<p>å‰ã®ãƒšãƒ¼ã‚¸ã§ã‚ãªãŸãŒå…¬é–‹ã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ—ãƒ©ãƒ³ã¯ã€Œ<span class="marker-inline"></span>ã€ã§ç¤ºã•ã‚Œã¦ã„ã¾ã™ã€‚<p>


<form method="post">

  <!-- ğŸ”¸2ã¤ã®ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚’å›²ã‚€ -->
  <div class="box-wrapper">
    <h3 class="box-heading">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ—ãƒ©ãƒ³ã®ä¿®æ­£</h3>
    <div class="slider-container">

      <!-- èµ¤ç‰ -->
      <div class="slider-box">
        <p><strong><span style="color:#ff6666">èµ¤ç‰</span>ãŒå¼•ã‹ã‚ŒãŸå ´åˆï¼š</strong></p>
        <input type="range" id="slider_r_R" min="0" max="100" step="1"
               value="{{ pi1_r_given_R }}" class="color-slider">
        <div class="marker" id="marker_r_R"></div>
        <p class="message-line">
          <span class="prob-value" id="v_r_R">--</span>ï¼…ã§ã€Œ<strong style="color:#ff6666">èµ¤è‰²</strong>ã€ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
        </p>
        <p class="message-line">
          <span class="prob-value" id="v_b_R">--</span>ï¼…ã§ã€Œ<strong style="color:#66ccff">é’è‰²</strong>ã€ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
        </p>
      </div>

      <!-- é’ç‰ -->
      <div class="slider-box">
        <p><strong><span style="color:#66ccff">é’ç‰</span>ãŒå¼•ã‹ã‚ŒãŸå ´åˆï¼š</strong></p>
        <input type="range" id="slider_r_B" min="0" max="100" step="1"
               value="{{ pi1_r_given_B }}" class="color-slider">
        <div class="marker" id="marker_r_B"></div>
        <p class="message-line">
          <span class="prob-value" id="v_r_B">--</span>ï¼…ã§ã€Œ<strong style="color:#ff6666">èµ¤è‰²</strong>ã€ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
        </p>
        <p class="message-line">
          <span class="prob-value" id="v_b_B">--</span>ï¼…ã§ã€Œ<strong style="color:#66ccff">é’è‰²</strong>ã€ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
        </p>
      </div>

    </div>
  </div>

  <!-- ğŸ”¸å…¨ä½“ã¨ã—ã¦ã®åˆ†å¸ƒã‚’å›²ã‚€ -->
  <div class="box-wrapper light">
    <h3 class="box-heading">å…¨ä½“ã§ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ç¢ºç‡ï¼ˆå›ºå®šï¼‰</h3>
    <input type="range" id="slider_marginal" min="0" max="100" step="1"
           value="{{ marginal_r_initial }}" class="color-slider no-thumb" disabled>

    <div style="display:flex;justify-content:space-between;">
      <span>ã€Œ<strong style="color:#ff6666">èµ¤è‰²</strong>ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒé€ä¿¡ã•ã‚Œã‚‹ç¢ºç‡ã¯
        <span class="prob-value" id="lab_r">{{ marginal_r_initial }}</span>ï¼…</span>
      <span>ã€Œ<strong style="color:#66ccff">é’è‰²</strong>ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒé€ä¿¡ã•ã‚Œã‚‹ç¢ºç‡ã¯
        <span class="prob-value" id="lab_b">{{ marginal_b_initial }}</span>ï¼…</span>
    </div>
  </div>

  <!-- hiddené€ä¿¡ç”¨ -->
  <input type="hidden" name="pi2_r_given_R" id="h_r_R">
  <input type="hidden" name="pi2_r_given_B" id="h_r_B">


<p>ä¿®æ­£ãŒå®Œäº†ã—ãŸã‚‰ã€Œæ¬¡ã¸ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚<p>
  <button class="btn btn-primary">æ¬¡ã¸</button>
</form>

<!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€ â¸  ã‚¹ã‚¯ãƒªãƒ—ãƒˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<script>
/* å®šæ•° */
const PR={{ PRIOR_R }}, PB={{ PRIOR_B }}, pR={{ marginal_r_initial }}/100;
const rR_min={{ rR_min }}, rR_max={{ rR_max }};
const rB_min={{ rB_min }}, rB_max={{ rB_max }};

/* DOM */
const sR=document.getElementById('slider_r_R');
const sB=document.getElementById('slider_r_B');
const sM=document.getElementById('slider_marginal');
const mR=document.getElementById('marker_r_R'), mB=document.getElementById('marker_r_B');
const v_r_R=document.getElementById('v_r_R'), v_b_R=document.getElementById('v_b_R');
const v_r_B=document.getElementById('v_r_B'), v_b_B=document.getElementById('v_b_B');
const h_r_R=document.getElementById('h_r_R'), h_r_B=document.getElementById('h_r_B');

/* ã‚«ãƒ©ãƒ¼ */
const dullRed='#f4caca', dullBlue='#c9ddf7', vividRed='#ff6666', vividBlue='#66ccff';

/* å¡—ã‚Šåˆ†ã‘é–¢æ•° */
function paint(sl,val,min,max){
  slider = document.getElementById(sl);
}
function paint(slider,val,min,max){
  slider.style.background=
   `linear-gradient(to right,
     ${dullRed} 0%, ${dullRed} ${min}%,
     ${vividRed} ${min}%, ${vividRed} ${val}%,
     ${vividBlue} ${val}%, ${vividBlue} ${max}%,
     ${dullBlue} ${max}%, ${dullBlue} 100%)`;
}
/* å‘¨è¾ºãƒãƒ¼ */
function paintMarginal(val){
  sM.style.background=`linear-gradient(to right,${vividRed} 0%,${vividRed} ${val}%,
                                         ${vividBlue} ${val}%,${vividBlue} 100%)`;
}
/* â–²ä½ç½® */
function mark(el,pct){ el.style.left=`calc(${pct}% - 7px)`; }
function clamp(x,min,max){return Math.min(Math.max(x,min),max);}

/* åŒæ–¹å‘åŒæœŸ */
let lock=false;
function sync(origin){
  if(lock) return; lock=true;
  let rR=sR.value/100, rB=sB.value/100;
  if(origin==='R') rB=(pR-PR*rR)/PB; else rR=(pR-PB*rB)/PR;

  rR=clamp(rR,rR_min/100,rR_max/100);
  rB=(pR-PR*rR)/PB;
  rB=clamp(rB,rB_min/100,rB_max/100);
  rR=(pR-PB*rB)/PR;

  const pRr=Math.round(rR*100), pBr=Math.round(rB*100);
  sR.value=pRr; sB.value=pBr;
  paint(sR,pRr,rR_min,rR_max); paint(sB,pBr,rB_min,rB_max);
  v_r_R.textContent=pRr; v_b_R.textContent=100-pRr;
  v_r_B.textContent=pBr; v_b_B.textContent=100-pBr;
  h_r_R.value=rR.toFixed(4); h_r_B.value=rB.toFixed(4);
  lock=false;
}

/* åˆæœŸãƒ­ãƒ¼ãƒ‰ï¼šãƒãƒ¼ã‚«ãƒ¼ãƒ»ãƒãƒ¼æç”»ã¨ãƒ©ãƒ™ãƒ«/hidden è¨­å®šã®ã¿ */
document.addEventListener('DOMContentLoaded',()=>{
  mark(mR,{{ pi1_r_given_R }}); mark(mB,{{ pi1_r_given_B }});
  paint(sR,sR.value,rR_min,rR_max);
  paint(sB,sB.value,rB_min,rB_max);
  paintMarginal({{ marginal_r_initial }});
  /* ãƒ©ãƒ™ãƒ«ã¨ hidden ã‚’åˆæœŸå€¤ã§ã‚»ãƒƒãƒˆ */
  v_r_R.textContent={{ pi1_r_given_R }};
  v_b_R.textContent=100-{{ pi1_r_given_R }};
  v_r_B.textContent={{ pi1_r_given_B }};
  v_b_B.textContent=100-{{ pi1_r_given_B }};
  h_r_R.value=({{ pi1_r_given_R }}/100).toFixed(4);
  h_r_B.value=({{ pi1_r_given_B }}/100).toFixed(4);
});

/* ã‚¤ãƒ™ãƒ³ãƒˆ */
sR.addEventListener('input',()=>sync('R'));
sB.addEventListener('input',()=>sync('B'));

// ã‚¿ã‚¤ãƒãƒ¼å‡¦ç†
let secondsLeft = 60;
function updateTimeDisplay() {
  const min = Math.floor(secondsLeft / 60);
  const sec = secondsLeft % 60;
  const timeStr = `${min}:${sec.toString().padStart(2, '0')}`;
  document.getElementById('time-left').textContent = timeStr;
}
updateTimeDisplay();
const timer = setInterval(() => {
  secondsLeft -= 1;
  updateTimeDisplay();
  if (secondsLeft <= 0) {
    clearInterval(timer);
    document.getElementById("timeout-warning").style.display = "block";
  }
}, 1000);
</script>
{% endblock %}
